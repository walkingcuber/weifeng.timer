<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>魔方計時器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #1e1e1e; color: #ffffff; touch-action: manipulation; -webkit-user-select: none; user-select: none; overflow: hidden; }
        .login-panel { background-color: #2c2c2c; border-radius: 1.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.5); width: 100%; max-width: 400px; padding: 2.5rem; }
        .login-input { background-color: #e8f0fe; color: #000; width: 100%; padding: 0.85rem; border-radius: 0.75rem; border: none; font-size: 1rem; }
        .timer-display { font-family: 'Roboto Mono', monospace; font-size: 6rem; transition: color 0.1s; }
        .hidden { display: none !important; }
        #login-btn { background-color: #007bff; border-radius: 0.75rem; transition: background-color 0.2s; }
        #login-btn:hover { background-color: #0056b3; }
        .scramble-text { color: #facc15; font-size: 1.5rem; font-family: 'Roboto Mono', monospace; min-height: 4.5rem; line-height: 1.5; }
    </style>
</head>
<body>

    <div id="login-container" class="flex items-center justify-center h-screen w-screen">
        <div class="login-panel text-center">
            <h1 class="text-3xl font-bold mb-8 text-white">登入計時器</h1>
            <div class="space-y-4">
                <input type="text" id="username-input" placeholder="帳號 (Email)" class="login-input">
                <input type="password" id="password-input" placeholder="密碼" class="login-input">
            </div>
            <p id="login-error" class="text-red-500 h-6 mt-2 text-sm"></p>
            <button id="login-btn" class="w-full text-white font-bold py-3 px-4 transition mt-6 text-lg">登入</button>
        </div>
    </div>

    <div id="app-container" class="hidden flex flex-col h-screen w-screen p-4 relative">
        <div id="user-info" class="absolute top-4 right-4 text-sm text-gray-400">
            <span id="display-username"></span>
            <button id="logout-btn" class="ml-2 underline hover:text-white">登出</button>
        </div>
                
        <header class="w-full text-center py-8">
            <div id="scramble" class="scramble-text p-2 max-w-2xl mx-auto">載入打亂公式中...</div>
        </header>

        <main class="flex-grow flex flex-col items-center justify-center">
            <div id="timer" class="timer-display font-bold">0.00</div>
            <div id="hint" class="mt-4 text-gray-500 text-lg uppercase tracking-widest">Hold Space to Ready</div>
                        
            <div class="mt-10 w-full max-w-xs">
                <h3 class="text-gray-400 text-sm mb-2 text-center uppercase tracking-widest">Recent Sessions</h3>
                <ul id="mini-history-list" class="space-y-2 text-3xl font-mono text-center text-gray-400"></ul>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDI95sVUBAs3iDMQlF115qNxXd-DPkBMbg",
            authDomain: "weifengtimer.firebaseapp.com",
            projectId: "weifengtimer",
            storageBucket: "weifengtimer.firebasestorage.app",
            messagingSenderId: "859708136196",
            appId: "1:859708136196:web:47386850f3df3e9858ce51",
            measurementId: "G-N8JFJ1E4WB"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let isRunning = false;
        let isReady = false;
        let startTime = 0;
        let requestID;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('display-username').textContent = user.email;
                document.getElementById('login-container').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                await loadHistory();
                generateScramble();
            } else {
                document.getElementById('login-container').classList.remove('hidden');
                document.getElementById('app-container').classList.add('hidden');
            }
        });

        document.getElementById('login-btn').onclick = async () => {
            const email = document.getElementById('username-input').value;
            const password = document.getElementById('password-input').value;
            document.getElementById('login-error').textContent = "驗證中...";
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (e) {
                document.getElementById('login-error').textContent = "密碼錯誤或使用者不存在";
            }
        };

        document.getElementById('logout-btn').onclick = () => signOut(auth);

        function generateScramble() {
            const moves = ["R", "L", "U", "D", "F", "B"];
            const mods = ["", "'", "2"];
            let scramble = [];
            let lastMove = "";
            for (let i = 0; i < 20; i++) {
                let move;
                do { move = moves[Math.floor(Math.random() * moves.length)]; } while (move === lastMove);
                lastMove = move;
                scramble.push(move + mods[Math.floor(Math.random() * mods.length)]);
            }
            document.getElementById('scramble').textContent = scramble.join(" ");
        }

        function tick() {
            if (!isRunning) return;
            const now = Date.now();
            document.getElementById('timer').textContent = ((now - startTime) / 1000).toFixed(2);
            requestID = requestAnimationFrame(tick);
        }

        window.onkeydown = (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                if (e.repeat) return; // 防止長按空白鍵重複觸發

                if (isRunning) {
                    // 1. 停止計時
                    isRunning = false;
                    cancelAnimationFrame(requestID);
                    const finalTime = document.getElementById('timer').textContent;
                    saveResult(finalTime);
                    generateScramble();
                } else {
                    // 2. 準備開始
                    isReady = true;
                    document.getElementById('timer').style.color = "#4ade80"; // 變綠
                    document.getElementById('timer').textContent = "0.00";
                }
            }
        };

        window.onkeyup = (e) => {
            if (e.code === 'Space') {
                if (isReady && !isRunning) {
                    // 3. 正式開始跑秒
                    isReady = false;
                    isRunning = true;
                    startTime = Date.now();
                    document.getElementById('timer').style.color = "#ffffff";
                    requestAnimationFrame(tick);
                }
            }
        };

        async function saveResult(timeStr) {
            const user = auth.currentUser;
            if (!user) return;
            try {
                await addDoc(collection(db, "users", user.uid, "times"), {
                    time: parseFloat(timeStr),
                    date: new Date()
                });
                await loadHistory();
            } catch (err) { console.error(err); }
        }

        async function loadHistory() {
            const user = auth.currentUser;
            if (!user) return;
            const q = query(collection(db, "users", user.uid, "times"), orderBy("date", "desc"), limit(5));
            const snap = await getDocs(q);
            const list = document.getElementById('mini-history-list');
            list.innerHTML = "";
            snap.forEach((doc) => {
                const li = document.createElement('li');
                li.className = "hover:text-white transition-colors";
                li.textContent = doc.data().time.toFixed(2);
                list.appendChild(li);
            });
        }
    </script>
</body>
</html>
