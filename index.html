<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ç™»å…¥è¨ˆæ™‚å™¨</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { 
      font-family: 'Roboto Mono', monospace;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    .timer-display { 
      font-size: 5rem;
      transition: color 0.3s;
      cursor: pointer;
    }
    .timer-display.ready { color: #10b981; }
    .timer-display.running { color: #3b82f6; }
    #scrambleDisplay {
      white-space: pre-line;
      min-height: 4em;
    }
    @media (max-width: 640px) {
      .timer-display { font-size: 4rem; }
    }
    /* éš±è—æ²è»¸ä½†ä¿ç•™åŠŸèƒ½ */
    .no-scrollbar::-webkit-scrollbar { display: none; }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">

<!-- ç™»å…¥ç•«é¢ -->
<div id="authScreen" class="flex items-center justify-center min-h-screen px-4">
  <div class="bg-gray-800 p-8 rounded-xl shadow-2xl max-w-sm w-full">
    <h1 class="text-3xl font-bold text-center mb-6 text-blue-500">Weifeng Timer</h1>
    <input type="email" id="emailInput" placeholder="é›»å­éƒµä»¶" 
           class="w-full p-4 mb-4 bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-white">
    <input type="password" id="passwordInput" placeholder="å¯†ç¢¼" 
           class="w-full p-4 mb-6 bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-white">
    <button id="loginBtn" class="w-full bg-blue-600 hover:bg-blue-700 p-4 rounded-lg font-bold transition active:scale-95">
      ç™»å…¥
    </button>
    <p id="authError" class="text-red-500 text-sm mt-4 text-center hidden"></p>
  </div>
</div>

<!-- ä¸»è¨ˆæ™‚å™¨ç•«é¢ -->
<div id="timerScreen" class="hidden flex flex-col min-h-screen">
  <!-- é ‚éƒ¨å°èˆª -->
  <div class="flex justify-between items-center p-4 bg-gray-800 shadow-md">
    <div class="text-sm">
      <span class="text-gray-400">User: </span>
      <span id="userEmail" class="text-blue-400 font-bold"></span>
    </div>
    <button id="logoutBtn" class="bg-gray-700 hover:bg-red-600 px-3 py-1 rounded text-sm transition">
      ç™»å‡º
    </button>
  </div>

  <!-- æ‰“äº‚å…¬å¼ -->
  <div class="px-4 text-center mt-6">
    <p id="scrambleDisplay" class="text-lg md:text-xl text-gray-300 font-medium leading-relaxed max-w-4xl mx-auto italic"></p>
  </div>

  <!-- è¨ˆæ™‚å™¨å€åŸŸ (æ”¯æ´é»æ“Šèˆ‡æŒ‰éµ) -->
  <div class="flex-grow flex flex-col items-center justify-center py-10 touch-none">
    <div id="timerDisplay" class="timer-display font-bold">0.00</div>
    <p id="timerHint" class="text-gray-500 mt-4 animate-pulse">æŒ‰ä½ç©ºç™½éµæˆ–é»æ“Šæ•¸å­—é–‹å§‹</p>
  </div>

  <!-- æˆç¸¾çµ±è¨ˆèˆ‡åˆ—è¡¨ -->
  <div class="max-w-5xl mx-auto w-full px-4 pb-20">
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-8">
      <div class="bg-gray-800 p-3 rounded-lg border border-gray-700">
        <p class="text-gray-500 text-xs uppercase">Avg</p>
        <p id="avgDisplay" class="text-xl font-bold">-</p>
      </div>
      <div class="bg-gray-800 p-3 rounded-lg border border-gray-700">
        <p class="text-gray-500 text-xs uppercase text-green-500">Best</p>
        <p id="bestDisplay" class="text-xl font-bold text-green-400">-</p>
      </div>
      <div class="bg-gray-800 p-3 rounded-lg border border-gray-700">
        <p class="text-gray-500 text-xs uppercase">ao5</p>
        <p id="ao5Display" class="text-xl font-bold text-blue-400">-</p>
      </div>
      <div class="bg-gray-800 p-3 rounded-lg border border-gray-700">
        <p class="text-gray-500 text-xs uppercase">ao12</p>
        <p id="ao12Display" class="text-xl font-bold text-purple-400">-</p>
      </div>
    </div>

    <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
      <span class="w-2 h-6 bg-blue-500 rounded"></span> æœ€è¿‘æˆç¸¾
    </h3>
    <div id="recentSessions" class="grid grid-cols-1 sm:grid-cols-2 gap-2">
      <p class="text-gray-600 italic">å°šç„¡æˆç¸¾æ•¸æ“š...</p>
    </div>
  </div>

  <!-- è¨­å®šæŒ‰éˆ• -->
  <button id="settingsBtn" class="fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-500 w-14 h-14 rounded-full shadow-2xl flex items-center justify-center transition active:scale-90 z-40">
    <span class="text-2xl text-white">âš™ï¸</span>
  </button>
</div>

<!-- è¨­å®šé¢æ¿ -->
<div id="settingsModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
  <div class="bg-gray-800 p-6 rounded-2xl max-w-md w-full shadow-2xl border border-gray-700">
    <h2 class="text-xl font-bold mb-6 flex justify-between">
      è¨­å®šé¢ç‰ˆ
      <button id="closeSettings" class="text-gray-400 hover:text-white">âœ•</button>
    </h2>
    
    <div class="space-y-6">
      <div>
        <label class="block text-gray-400 text-sm mb-2">é¸æ“‡è¨ˆæ™‚é …ç›®</label>
        <select id="eventSelect" class="w-full p-3 bg-gray-700 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
          <option value="333">3x3x3 Cube</option>
          <option value="222">2x2x2 Cube</option>
          <option value="444">4x4x4 Cube</option>
          <option value="555">5x5x5 Cube</option>
          <option value="minx">Megaminx</option>
          <option value="pyram">Pyraminx</option>
          <option value="skewb">Skewb</option>
        </select>
      </div>

      <div class="pt-4 border-t border-gray-700 text-xs text-gray-500">
        æç¤ºï¼šè¡Œå‹•è£ç½®å¯ç›´æ¥é»æ“Šè¨ˆæ™‚å™¨æ•¸å­—å€åŸŸé–‹å§‹/åœæ­¢ã€‚
      </div>

      <button id="saveSettingsBtn" class="w-full bg-blue-600 hover:bg-blue-700 p-3 rounded-xl font-bold transition">
        å„²å­˜ä¸¦é—œé–‰
      </button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
  import { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, limit, getDocs, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: "AIzaSyDI95sVUBAs3iDMQlF115qNxXd-DPkBMbg",
    authDomain: "weifengtimer.firebaseapp.com",
    projectId: "weifengtimer",
    storageBucket: "weifengtimer.firebasestorage.app",
    messagingSenderId: "859708136196",
    appId: "1:859708136196:web:47386850f3df3e9858ce51",
    measurementId: "G-N8JFJ1E4WB"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // UI Elements
  const timerDisplay = document.getElementById('timerDisplay');
  const scrambleDisplay = document.getElementById('scrambleDisplay');
  const recentSessions = document.getElementById('recentSessions');
  const eventSelect = document.getElementById('eventSelect');

  let timerState = 'idle'; 
  let startTime = 0;
  let currentTime = 0;
  let animationFrame = null;
  let holdTimer = null;
  let currentUser = null;
  let currentScramble = '';
  let currentEvent = '333';

  // Scramble Logic
  const scrambleGenerators = {
    '222': () => generateScramble(['U', 'R', 'F'], 9),
    '333': () => generateScramble(['U', 'D', 'L', 'R', 'F', 'B'], 20),
    '444': () => generateScramble(['U', 'D', 'L', 'R', 'F', 'B', 'u', 'd', 'l', 'r', 'f', 'b'], 40),
    '555': () => generateScramble(['U', 'D', 'L', 'R', 'F', 'B', 'u', 'd', 'l', 'r', 'f', 'b'], 60),
    'minx': () => generateMegaminxScramble(),
    'pyram': () => generateScramble(['U', 'L', 'R', 'B'], 11),
    'skewb': () => generateScramble(['U', 'L', 'R', 'B'], 11)
  };

  function generateScramble(moves, length) {
    let scramble = [];
    let lastMove = '';
    const modifiers = ['', "'", '2'];
    for (let i = 0; i < length; i++) {
      let move;
      do { move = moves[Math.floor(Math.random() * moves.length)]; } 
      while (move === lastMove || move.toLowerCase() === lastMove.toLowerCase());
      const modifier = modifiers[Math.floor(Math.random() * modifiers.length)];
      scramble.push(move + modifier);
      lastMove = move;
    }
    return scramble.join(' ');
  }

  function generateMegaminxScramble() {
    let scramble = [];
    for (let i = 0; i < 7; i++) {
      let moves = [];
      for (let j = 0; j < 10; j++) {
        moves.push(Math.random() < 0.5 ? "R++" : "R--", Math.random() < 0.5 ? "D++" : "D--");
      }
      moves.push("U" + (Math.random() < 0.5 ? "'" : ""));
      scramble.push(moves.join(' '));
    }
    return scramble.join('\n');
  }

  function newScramble() {
    currentScramble = scrambleGenerators[currentEvent]();
    scrambleDisplay.textContent = currentScramble;
  }

  // Auth Functions
  document.getElementById('loginBtn').addEventListener('click', async () => {
    const email = document.getElementById('emailInput').value.trim();
    const password = document.getElementById('passwordInput').value;
    try {
      await signInWithEmailAndPassword(auth, email, password);
    } catch (error) {
      const errEl = document.getElementById('authError');
      errEl.textContent = "ç™»å…¥å¤±æ•—: " + error.message;
      errEl.classList.remove('hidden');
    }
  });

  document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth));

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      document.getElementById('userEmail').textContent = user.email;
      document.getElementById('authScreen').classList.add('hidden');
      document.getElementById('timerScreen').classList.remove('hidden');
      newScramble();
      await loadRecentSessions();
    } else {
      currentUser = null;
      document.getElementById('authScreen').classList.remove('hidden');
      document.getElementById('timerScreen').classList.add('hidden');
    }
  });

  // Timer Core Logic
  function updateDisplay() {
    const elapsed = (currentTime - startTime) / 1000;
    timerDisplay.textContent = elapsed.toFixed(2);
    if (timerState === 'running') {
      currentTime = Date.now();
      animationFrame = requestAnimationFrame(updateDisplay);
    }
  }

  function startTimer() {
    if (timerState !== 'ready') return;
    timerState = 'running';
    startTime = Date.now();
    currentTime = startTime;
    timerDisplay.classList.remove('ready');
    timerDisplay.classList.add('running');
    document.getElementById('timerHint').textContent = 'è¨ˆæ™‚ä¸­...';
    updateDisplay();
  }

  function stopTimer() {
    if (timerState !== 'running') return;
    timerState = 'stopped';
    cancelAnimationFrame(animationFrame);
    timerDisplay.classList.remove('running');
    document.getElementById('timerHint').textContent = 'å·²åœæ­¢ï¼Œé»æ“Šé‡ç½®';
    const finalTime = parseFloat(((Date.now() - startTime) / 1000).toFixed(2));
    saveSession(finalTime);
  }

  function resetTimer() {
    timerState = 'idle';
    timerDisplay.textContent = '0.00';
    timerDisplay.classList.remove('ready', 'running');
    document.getElementById('timerHint').textContent = 'æŒ‰ä½ç©ºç™½éµæˆ–é»æ“Šæ•¸å­—é–‹å§‹';
    newScramble();
  }

  // Key Listeners
  document.addEventListener('keydown', (e) => {
    if (e.code !== 'Space' || !currentUser || e.repeat) return;
    e.preventDefault();
    handlePressStart();
  });
  document.addEventListener('keyup', (e) => {
    if (e.code !== 'Space' || !currentUser) return;
    e.preventDefault();
    handlePressEnd();
  });

  // Touch Listeners (Mobile)
  timerDisplay.addEventListener('touchstart', (e) => {
    if (!currentUser) return;
    e.preventDefault();
    handlePressStart();
  }, { passive: false });

  timerDisplay.addEventListener('touchend', (e) => {
    if (!currentUser) return;
    e.preventDefault();
    handlePressEnd();
  }, { passive: false });

  function handlePressStart() {
    if (timerState === 'idle') {
      holdTimer = setTimeout(() => {
        timerState = 'ready';
        timerDisplay.classList.add('ready');
        document.getElementById('timerHint').textContent = 'æ”¾é–‹é–‹å§‹';
      }, 300);
    } else if (timerState === 'running') {
      stopTimer();
    }
  }

  function handlePressEnd() {
    if (holdTimer) {
      clearTimeout(holdTimer);
      holdTimer = null;
    }
    if (timerState === 'ready') {
      startTimer();
    } else if (timerState === 'stopped') {
      resetTimer();
    }
  }

  // Firestore Operations
  async function saveSession(time) {
    if (!currentUser) return;
    const sessionData = {
      time,
      scramble: currentScramble,
      event: currentEvent,
      timestamp: Date.now()
    };
    try {
      const sessionRef = doc(collection(db, `users/${currentUser.uid}/sessions`));
      await setDoc(sessionRef, sessionData);
      await loadRecentSessions();
    } catch (e) { console.error('Error saving:', e); }
  }

  async function loadRecentSessions() {
    if (!currentUser) return;
    try {
      const q = query(
        collection(db, `users/${currentUser.uid}/sessions`),
        orderBy('timestamp', 'desc'),
        limit(20)
      );
      const snapshot = await getDocs(q);
      const sessions = [];
      snapshot.forEach(doc => sessions.push({ id: doc.id, ...doc.data() }));
      displaySessions(sessions);
      calculateStats(sessions);
    } catch (e) { console.error('Error loading:', e); }
  }

  function displaySessions(sessions) {
    if (sessions.length === 0) {
      recentSessions.innerHTML = '<p class="text-gray-600 italic">å°šç„¡æˆç¸¾æ•¸æ“š...</p>';
      return;
    }
    recentSessions.innerHTML = sessions.map((s) => `
      <div class="bg-gray-800 p-4 rounded-xl flex justify-between items-center group border border-gray-700 hover:border-blue-500/50 transition shadow-sm">
        <div>
          <span class="text-2xl font-bold font-mono">${s.time.toFixed(2)}</span>
          <p class="text-[10px] text-gray-500">${new Date(s.timestamp).toLocaleString()}</p>
        </div>
        <button onclick="window.deleteSession('${s.id}')" class="opacity-0 group-hover:opacity-100 p-2 text-gray-500 hover:text-red-500 transition-all active:scale-90">
          ğŸ—‘ï¸
        </button>
      </div>
    `).join('');
  }

  // Global Delete Function
  window.deleteSession = async (id) => {
    if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†æˆç¸¾å—ï¼Ÿ')) return;
    try {
      await deleteDoc(doc(db, `users/${currentUser.uid}/sessions`, id));
      await loadRecentSessions();
    } catch (e) { alert('åˆªé™¤å¤±æ•—'); }
  };

  function calculateStats(sessions) {
    if (sessions.length === 0) return;
    const times = sessions.map(s => s.time);
    const avg = (times.reduce((a, b) => a + b, 0) / times.length).toFixed(2);
    const best = Math.min(...times).toFixed(2);
    
    document.getElementById('avgDisplay').textContent = avg;
    document.getElementById('bestDisplay').textContent = best;
    
    if (times.length >= 5) {
      const ao5 = calculateAverage(times.slice(0, 5));
      document.getElementById('ao5Display').textContent = ao5.toFixed(2);
    } else { document.getElementById('ao5Display').textContent = '-'; }
    
    if (times.length >= 12) {
      const ao12 = calculateAverage(times.slice(0, 12));
      document.getElementById('ao12Display').textContent = ao12.toFixed(2);
    } else { document.getElementById('ao12Display').textContent = '-'; }
  }

  function calculateAverage(times) {
    const sorted = [...times].sort((a, b) => a - b);
    const trimmed = sorted.slice(1, -1);
    return trimmed.reduce((a, b) => a + b, 0) / trimmed.length;
  }

  // Settings UI
  const settingsModal = document.getElementById('settingsModal');
  document.getElementById('settingsBtn').addEventListener('click', () => settingsModal.classList.remove('hidden'));
  document.getElementById('closeSettings').addEventListener('click', () => settingsModal.classList.add('hidden'));
  document.getElementById('saveSettingsBtn').addEventListener('click', () => settingsModal.classList.add('hidden'));
  
  eventSelect.addEventListener('change', (e) => {
    currentEvent = e.target.value;
    newScramble();
  });
</script>
</body>
</html>
