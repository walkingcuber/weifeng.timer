<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>專業魔方計時器</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { 
      font-family: 'Roboto Mono', 'Noto Sans TC', monospace;
      user-select: none;
      transition: background-color 0.3s;
    }
    .timer-display { 
      font-size: 6rem;
      transition: color 0.1s;
    }
    .timer-display.ready { color: #10b981; }
    .timer-display.running { color: #3b82f6; }
    @media (max-width: 640px) {
      .timer-display { font-size: 4rem; }
    }
    /* 主題定義 */
    .theme-dark { background-color: #111827; color: white; }
    .theme-light { background-color: #f3f4f6; color: #1f2937; }
    .theme-blue { background-color: #1e3a8a; color: white; }
    
    .panel { background-color: rgba(31, 41, 55, 0.8); }
    .theme-light .panel { background-color: white; border: 1px solid #e5e7eb; }
  </style>
</head>
<body class="theme-dark min-h-screen">

<div id="authScreen" class="flex items-center justify-center min-h-screen p-4">
  <div class="bg-gray-800 p-8 rounded-xl shadow-2xl max-w-sm w-full panel">
    <h1 class="text-3xl font-bold text-center mb-6">登入計時器</h1>
    <input type="text" id="usernameInput" placeholder="帳號" 
           class="w-full p-4 mb-4 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
    <input type="password" id="passwordInput" placeholder="密碼" 
           class="w-full p-4 mb-6 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
    <button id="loginBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-lg font-bold transition">
      登入
    </button>
    <p id="authError" class="text-red-500 text-sm mt-4 text-center hidden"></p>
  </div>
</div>

<div id="timerScreen" class="hidden">
  <div class="flex justify-between items-center p-4 bg-gray-800 panel">
    <div>
      <span class="opacity-60 text-sm">歡迎, </span>
      <span id="displayUser" class="text-blue-400 font-bold"></span>
    </div>
    <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm transition">
      登出
    </button>
  </div>

  <div class="text-center mt-8 px-4">
    <p id="scrambleDisplay" class="text-xl md:text-2xl font-bold tracking-wide text-yellow-400"></p>
  </div>

  <div class="flex flex-col items-center justify-center mt-12 mb-12">
    <div id="timerDisplay" class="timer-display font-bold">0.00</div>
    <p id="timerHint" class="text-gray-500 mt-4">按住空白鍵開始</p>
  </div>

  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 max-w-4xl mx-auto px-4">
    <div class="bg-gray-800 p-4 rounded-lg text-center panel">
      <p class="opacity-60 text-xs uppercase">目前平均</p>
      <p id="avgDisplay" class="text-2xl font-bold">-</p>
    </div>
    <div class="bg-gray-800 p-4 rounded-lg text-center panel">
      <p class="opacity-60 text-xs uppercase text-green-400">最佳成績</p>
      <p id="bestDisplay" class="text-2xl font-bold">-.--</p>
    </div>
    <div class="bg-gray-800 p-4 rounded-lg text-center panel">
      <p class="opacity-60 text-xs uppercase">ao5</p>
      <p id="ao5Display" class="text-2xl font-bold">-</p>
    </div>
    <div class="bg-gray-800 p-4 rounded-lg text-center panel">
      <p class="opacity-60 text-xs uppercase">ao12</p>
      <p id="ao12Display" class="text-2xl font-bold">-</p>
    </div>
  </div>

  <div class="max-w-4xl mx-auto mt-10 px-4 pb-20">
    <div class="flex justify-between items-end mb-4">
        <h3 class="text-xl font-bold">最近成績</h3>
        <button id="clearHistoryBtn" class="text-gray-500 hover:text-red-400 text-sm underline">清除紀錄</button>
    </div>
    <div id="recentSessions" class="grid grid-cols-1 sm:grid-cols-2 gap-2">
      </div>
  </div>

  <button id="settingsBtn" class="fixed bottom-8 right-8 bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-full shadow-lg transition z-10">
    ⚙️
  </button>
</div>

<div id="settingsModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
  <div class="bg-gray-800 p-8 rounded-xl max-w-md w-full panel">
    <h2 class="text-2xl font-bold mb-6">計時器設定</h2>
    
    <div class="mb-6">
      <label class="block opacity-60 mb-2">WCA 項目</label>
      <select id="eventSelect" class="w-full p-3 bg-gray-700 rounded-lg text-white">
        <option value="3x3">3x3x3 方塊</option>
        <option value="2x2">2x2x2 方塊</option>
        <option value="4x4">4x4x4 方塊</option>
        <option value="5x5">5x5x5 方塊</option>
        <option value="pyraminx">Pyraminx</option>
        <option value="skewb">Skewb</option>
        <option value="megaminx">Megaminx</option>
      </select>
    </div>

    <div class="mb-8">
      <label class="block opacity-60 mb-2">主題配色</label>
      <div class="flex gap-2">
        <button onclick="changeTheme('dark')" class="flex-1 p-2 bg-gray-900 border border-gray-600 rounded">深色</button>
        <button onclick="changeTheme('light')" class="flex-1 p-2 bg-gray-100 text-black rounded">淺色</button>
        <button onclick="changeTheme('blue')" class="flex-1 p-2 bg-blue-900 rounded">藍色</button>
      </div>
    </div>

    <button id="closeSettings" class="w-full bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg font-bold">
      完成返回
    </button>
  </div>
</div>

<script>
  // --- 300 組用戶資料庫 (保留改良版的核心) ---
  const users = {
    "weifeng001": "weifeng3614", "weifeng002": "weifeng8491", "weifeng003": "weifeng6130", // ...(此處省略其餘，請保留您原始代碼中的300組)
    "weifeng300": "weifeng5886"
  };

  // 狀態變數
  let currentUser = null;
  let timerState = 'idle'; // idle, ready, running
  let startTime = 0;
  let currentTime = 0;
  let animationFrame = null;
  let times = [];
  let currentEvent = '3x3';
  let holdTimer = null;

  // DOM 元素
  const authScreen = document.getElementById('authScreen');
  const timerScreen = document.getElementById('timerScreen');
  const timerDisplay = document.getElementById('timerDisplay');
  const scrambleDisplay = document.getElementById('scrambleDisplay');
  const displayUser = document.getElementById('displayUser');
  const authError = document.getElementById('authError');

  // --- 初始化功能 ---
  function init() {
    const saved = sessionStorage.getItem('cubeTimerUser');
    if (saved) loginSuccess(saved);

    document.getElementById('loginBtn').onclick = handleLogin;
    document.getElementById('logoutBtn').onclick = handleLogout;
    document.getElementById('settingsBtn').onclick = () => document.getElementById('settingsModal').classList.remove('hidden');
    document.getElementById('closeSettings').onclick = () => document.getElementById('settingsModal').classList.add('hidden');
    document.getElementById('eventSelect').onchange = (e) => {
        currentEvent = e.target.value;
        loadData();
        newScramble();
    };
    document.getElementById('clearHistoryBtn').onclick = clearHistory;
  }

  // --- 登入邏輯 ---
  function handleLogin() {
    const u = document.getElementById('usernameInput').value;
    const p = document.getElementById('passwordInput').value;
    if (users[u] && users[u] === p) {
      loginSuccess(u);
    } else {
      authError.textContent = "帳號或密碼錯誤";
      authError.classList.remove('hidden');
    }
  }

  function loginSuccess(user) {
    currentUser = user;
    sessionStorage.setItem('cubeTimerUser', user);
    displayUser.textContent = user;
    authScreen.classList.add('hidden');
    timerScreen.classList.remove('hidden');
    loadData();
    newScramble();
  }

  function handleLogout() {
    sessionStorage.removeItem('cubeTimerUser');
    location.reload();
  }

  // --- 打亂公式生成 (WCA 簡化版) ---
  function newScramble() {
    const moves = {
        '3x3': ['U','D','L','R','F','B'],
        '2x2': ['U','R','F'],
        'pyraminx': ['U','L','R','B'],
        'skewb': ['U','L','R','B']
    };
    const currentMoves = moves[currentEvent] || moves['3x3'];
    let scramble = [];
    let last = "";
    for(let i=0; i< (currentEvent==='2x2'?9:20); i++){
        let m;
        do { m = currentMoves[Math.floor(Math.random()*currentMoves.length)]; } while(m===last);
        const mod = ["","'","2"][Math.floor(Math.random()*3)];
        scramble.push(m + mod);
        last = m;
    }
    scrambleDisplay.textContent = scramble.join(" ");
  }

  // --- 計時器核心邏輯 (原始版體驗) ---
  function updateTimer() {
    if (timerState === 'running') {
        currentTime = Date.now();
        const elapsed = (currentTime - startTime) / 1000;
        timerDisplay.textContent = elapsed.toFixed(2);
        animationFrame = requestAnimationFrame(updateTimer);
    }
  }

  window.addEventListener('keydown', (e) => {
    if (e.code !== 'Space' || currentUser === null) return;
    if (document.activeElement.tagName === 'INPUT') return;
    e.preventDefault();

    if (timerState === 'running') {
        stopTimer();
    } else if (timerState === 'idle') {
        timerState = 'ready';
        timerDisplay.classList.add('ready');
    }
  });

  window.addEventListener('keyup', (e) => {
    if (e.code !== 'Space' || currentUser === null) return;
    e.preventDefault();

    if (timerState === 'ready') {
        startTimer();
    }
  });

  function startTimer() {
    timerState = 'running';
    startTime = Date.now();
    timerDisplay.classList.remove('ready');
    timerDisplay.classList.add('running');
    updateTimer();
  }

  function stopTimer() {
    timerState = 'idle';
    timerDisplay.classList.remove('running');
    const finalTime = parseFloat(((Date.now() - startTime) / 1000).toFixed(2));
    saveTime(finalTime);
    newScramble();
  }

  // --- 數據儲存 ---
  function saveTime(time) {
    times.unshift({ time, date: new Date().toLocaleTimeString() });
    localStorage.setItem(`times_${currentUser}_${currentEvent}`, JSON.stringify(times));
    updateUI();
  }

  function loadData() {
    const saved = localStorage.getItem(`times_${currentUser}_${currentEvent}`);
    times = saved ? JSON.parse(saved) : [];
    updateUI();
  }

  function clearHistory() {
    if(confirm("確定要刪除此項目的所有紀錄嗎？")) {
        times = [];
        localStorage.removeItem(`times_${currentUser}_${currentEvent}`);
        updateUI();
    }
  }

  function updateUI() {
    // 更新最近成績列表
    const list = document.getElementById('recentSessions');
    list.innerHTML = times.slice(0, 10).map((t, i) => `
        <div class="bg-gray-800 p-3 rounded flex justify-between items-center panel">
            <span class="opacity-40 text-xs">#${times.length - i}</span>
            <span class="text-xl font-bold">${t.time.toFixed(2)}</span>
            <span class="opacity-40 text-xs">${t.date}</span>
        </div>
    `).join('');

    // 更新統計資料
    if (times.length > 0) {
        const rawTimes = times.map(t => t.time);
        document.getElementById('bestDisplay').textContent = Math.min(...rawTimes).toFixed(2);
        document.getElementById('avgDisplay').textContent = (rawTimes.reduce((a,b)=>a+b)/rawTimes.length).toFixed(2);
        
        document.getElementById('ao5Display').textContent = calculateAoN(rawTimes, 5);
        document.getElementById('ao12Display').textContent = calculateAoN(rawTimes, 12);
    } else {
        document.getElementById('bestDisplay').textContent = "-.--";
        document.getElementById('avgDisplay').textContent = "-";
        document.getElementById('ao5Display').textContent = "-";
        document.getElementById('ao12Display').textContent = "-";
    }
  }

  function calculateAoN(arr, n) {
    if (arr.length < n) return "-";
    const sub = arr.slice(0, n).sort((a,b)=>a-b);
    sub.pop(); // 去掉最慢
    sub.shift(); // 去掉最快
    return (sub.reduce((a,b)=>a+b)/sub.length).toFixed(2);
  }

  function changeTheme(theme) {
    document.body.className = `theme-${theme} min-h-screen`;
  }

  init();
</script>
</body>
</html>
